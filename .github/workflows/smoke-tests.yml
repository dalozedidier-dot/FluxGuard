name: smoke-tests

on:
  push:
  pull_request:
  workflow_dispatch:

concurrency:
  group: fluxguard-smoke-${{ github.ref }}
  cancel-in-progress: true

jobs:
  smoke:
    name: smoke (ubuntu-latest)
    runs-on: ubuntu-latest
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]

    env:
      PYTHONHASHSEED: "0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: |
            fluxguard/requirements*.txt
            fluxguard/pyproject.toml
            fluxguard/setup.py

      - name: System debug (before)
        run: |
          free -h
          df -h
          uname -a
          lsb_release -a || cat /etc/os-release

      - name: Prepare virtual environment + deps
        working-directory: fluxguard
        shell: bash
        run: |
          set -euo pipefail
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel

          echo "pip cache:"
          python -m pip cache dir
          python -m pip cache info || true

          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          if [ -f requirements-optional.txt ]; then pip install -r requirements-optional.txt; fi

          pip list --format=freeze

      - name: Prepare directories + deterministic smoke sample
        working-directory: fluxguard
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p _ci_out _ci datasets
          if [ ! -f _ci/constraints.txt ]; then
            printf "seed=ci
" > _ci/constraints.txt
          fi
          if [ -f datasets/example.csv ]; then
            source .venv/bin/activate
            python tools/make_smoke_sample.py datasets/example.csv datasets/example_smoke.csv --ratio 0.1 --max-rows 5000 --min-rows 200
            ls -lah datasets/example_smoke.csv
          else
            echo "datasets/example.csv not found; skipping smoke sample generation"
          fi

      - name: Smoke suite (reduced scope) with retry
        working-directory: fluxguard
        shell: bash
        run: |
          set -euo pipefail
          source .venv/bin/activate

          INPUT="datasets/example.csv"
          if [ -f datasets/example_smoke.csv ]; then
            INPUT="datasets/example_smoke.csv"
          fi

          success=false
          for attempt in 1 2 3; do
            echo ""
            echo "Attempt ${attempt}/3"

            rm -rf _ci_out
            mkdir -p _ci_out

            python -m compileall -q . 2>/dev/null || echo "compileall warnings (non-fatal)"

            python fluxguard.py nulltrace --runs 3 --output-dir _ci_out/nulltrace || { echo "nulltrace failed"; continue; }
            python fluxguard.py riftlens  --input "${INPUT}" --output-dir _ci_out/riftlens || { echo "riftlens failed"; continue; }
            python fluxguard.py voidmark  --input "${INPUT}" --runs 5 --output-dir _ci_out/voidmark || { echo "voidmark failed"; continue; }
            python fluxguard.py all       --shadow-prev "${INPUT}" --shadow-curr "${INPUT}" --output-dir _ci_out/full || { echo "all failed"; continue; }

            success=true
            break
          done

          [ "$success" = true ] || { echo "Smoke failed after 3 attempts"; exit 1; }

      - name: System debug (after)
        if: always()
        run: |
          free -h
          df -h

      - name: Debug on failure (env + packages)
        if: failure()
        working-directory: fluxguard
        shell: bash
        run: |
          source .venv/bin/activate || true
          cat /etc/os-release 2>/dev/null || lsb_release -a
          python --version
          pip --version
          pip list --format=freeze

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fluxguard-smoke-ubuntu-latest-py${{ matrix.python-version }}-attempt${{ github.run_attempt }}
          path: fluxguard/_ci_out
          if-no-files-found: warn

  smoke-22:
    name: smoke-guard (ubuntu-22.04, continue-on-error)
    runs-on: ubuntu-22.04
    continue-on-error: true
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12"]

    env:
      PYTHONHASHSEED: "0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: |
            fluxguard/requirements*.txt
            fluxguard/pyproject.toml
            fluxguard/setup.py

      - name: Prepare virtual environment + deps
        working-directory: fluxguard
        shell: bash
        run: |
          set -euo pipefail
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          if [ -f requirements-optional.txt ]; then pip install -r requirements-optional.txt; fi

      - name: Smoke suite (quick)
        working-directory: fluxguard
        shell: bash
        run: |
          set -euo pipefail
          source .venv/bin/activate
          rm -rf _ci_out && mkdir -p _ci_out
          python fluxguard.py nulltrace --runs 3 --output-dir _ci_out/nulltrace
          python fluxguard.py riftlens --input datasets/example.csv --output-dir _ci_out/riftlens
          python fluxguard.py voidmark --input datasets/example.csv --runs 5 --output-dir _ci_out/voidmark
          python fluxguard.py all --shadow-prev datasets/example.csv --shadow-curr datasets/example.csv --output-dir _ci_out/full

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fluxguard-smoke-ubuntu-22.04-py${{ matrix.python-version }}-attempt${{ github.run_attempt }}
          path: fluxguard/_ci_out
          if-no-files-found: warn
