name: smoke-tests

on:
  push:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # nightly à 3h UTC

concurrency:
  group: fluxguard-smoke-${{ github.ref }}
  cancel-in-progress: true

jobs:
  smoke:
    name: smoke (ubuntu-latest)
    runs-on: ubuntu-latest
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]

    env:
      PYTHONHASHSEED: "0"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: |
            fluxguard/requirements*.txt
            fluxguard/pyproject.toml
            fluxguard/setup.py

      - name: System debug (resources)
        run: |
          free -h && df -h && uname -a && (lsb_release -a || cat /etc/os-release)

      - name: Setup FluxGuard environment
        working-directory: fluxguard
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt           || true
          pip install -r requirements-dev.txt       || true
          pip install -r requirements-optional.txt  || true
          pip list --format=freeze

      - name: Generate reduced smoke sample
        working-directory: fluxguard
        run: |
          source .venv/bin/activate
          if [ -f datasets/example.csv ]; then
            python tools/make_smoke_sample.py datasets/example.csv datasets/example_smoke.csv --ratio 0.1 --max-rows 5000 --min-rows 200 || echo "Sample failed (non-blocking)"
          fi

      - name: Run smoke suite (reduced)
        working-directory: fluxguard
        run: |
          source .venv/bin/activate
          INPUT="datasets/example.csv"
          [ -f datasets/example_smoke.csv ] && INPUT="datasets/example_smoke.csv"

          for attempt in {1..3}; do
            rm -rf _ci_out && mkdir -p _ci_out
            python -m compileall -q . 2>/dev/null || echo "compileall ok"
            python fluxguard.py nulltrace --runs 3 --output-dir _ci_out/nulltrace &&
            python fluxguard.py riftlens  --input "$INPUT" --output-dir _ci_out/riftlens  &&
            python fluxguard.py voidmark  --input "$INPUT" --runs 5 --output-dir _ci_out/voidmark  &&
            python fluxguard.py all       --shadow-prev "$INPUT" --shadow-curr "$INPUT" --output-dir _ci_out/full &&
            { echo "Smoke succeeded"; exit 0; } ||
            { echo "Attempt $attempt failed"; sleep $((attempt*10)); }
          done
          exit 1

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fluxguard-smoke-latest-py${{ matrix.python-version }}-attempt${{ github.run_attempt }}
          path: fluxguard/_ci_out
          if-no-files-found: warn

  guard-22:
    name: smoke-guard (ubuntu-22.04 fallback)
    runs-on: ubuntu-22.04
    continue-on-error: true
    timeout-minutes: 45
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
      # ... mêmes steps que ci-dessus (factorisables plus tard)
